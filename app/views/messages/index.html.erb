<!--completed-->

<% provide(:title, "Inbox") %>

<header class="header-static-gray">
  <%= render 'layouts/header_secondary' %>
</header>

<%= render 'layouts/modal_search' %>

<%= render 'layouts/modal_menu' %>

<%= render 'layouts/hero_backend' %>

<nav class="secondary-navbar hidden-xs">
  <div class="secondary-navbar-nav">
    <ul class="nav navbar-nav navbar-left">
      <li><%= link_to "Dashboard",   dashboard_path %></li>
      <li class="nav-active"><%= link_to "Inbox", conversations_path %></li>
      <li><%= link_to "Your Garage", vehicles_path %></li>
      <li><%= link_to "Showroom",    test_drives_path %></li>
      <li><%= link_to "Profile",     edit_user_path(current_user) %></li>
    </ul>
  </div>
</nav>

<nav class="dropdown dropdown-backend visible-xs-block">
  
  <a href='#' class="dropdown-toggle" data-toggle="dropdown">
    Inbox <b class="caret"></b>
  </a>
  
  <ul class="dropdown-menu">
    <li><%= link_to "Dashboard",   dashboard_path %></li>
    <li class="dropdown-active"><%= link_to "Inbox", conversations_path %></li>
    <li><%= link_to "Your Garage", vehicles_path %></li>
    <li><%= link_to "Showroom",    test_drives_path %></li>
    <li><%= link_to "Profile",     edit_user_path(current_user) %></li>
  </ul>
</nav>

<div class="backend">
  <div class="backend-content">
    <div class="row">
      
      <div class="col-md-3 messages-info">
        
        <div class="messages-info-recipient">
          
          <%= link_to user_path(@other) do %>
            <div class="recipient-avatar avatar-general", 
                 style="background-image: url(
                         '<%= @other.avatar.url(:thumb) %>')">
            </div>
          <% end %>

          <div class='recipient-username'>
            
            <%= link_to @other.full_name,
                        user_path(@other) %>
                        
            <% if @other.online? %>
              <div class="online-name online-name-lg hidden-xs"></div>
            <% end %>
          </div>

          <% if @other.residence.present? %>
            <span class="recipient-city">
              <%= @other.residence %>
            </span>
          <% end %>
        
          <% if @other.phone_number.present? %>
            <%= link_to @other.phone_number.phony_formatted(spaces: '-'), 
                        '#', 
                        class: "recipient-phone" %>
          <% end %>
  
          <% if @other.description.present? %>
          
            <p class="recipient-description">
              <%= @other.description %>
            </p>
            
            <span class="recipient-expand">+ More</span>
          <% end %>
        </div>
        
        <% if @conversation.appointments.exists? %>
          <div class="messages-info-requests hidden-xs">
            
            <% if @conversation.appointments.where(
                    "buyer_id = ? AND date >= ?",
                    @other.id,
                    Time.now
                  ).exists? %>
              
              <div class="requests-received">
                    
                <h2 class="requests-title">
                  Requests Received
                  (<%= @conversation.appointments.where(
                         "buyer_id = ? AND date >= ?",
                         @other.id,
                         Time.now
                       ).count %>)
                </h2>
                
                <ol class="requests-list">
                  <% @conversation.appointments.where(
                       "buyer_id = ? AND date >= ?",
                       @other.id,
                       Time.now
                     ).each do |appointment| %>
                     
                    <li id="request-item-<%= appointment.id %>" 
                        class="request-item">
                      <table class="request-item-content">
                        <tr>
                          
                          <td class="request-item-detail">
                            
                            <%= link_to appointment.vehicle.listing_name,
                                        appointment.vehicle, 
                                        class: "request-item-vehicle" %>
                            
                            <span class="request-item-date">
                              <%= appointment.date.strftime(
                                    "%A, %d %b (%-l:%M%p)"
                                  ) %>
                            </span>
                          </td>
                          
                          <td class="request-item-status-container">
                            <span class="request-item-status 
                                         <%= appointment.status %>">
                              <%= appointment.status.capitalize %>
                            </span>
                          </td>
                        </tr>
                      </table>  
                    </li>
                  <% end %>
                </ol>
              </div>
            <% end %>
          
            <% if @conversation.appointments.where(
                    "buyer_id = ? AND date >= ?",
                    current_user.id,
                    Time.now
                  ).exists? %>
              
              <div class="requests-sent">
                    
                <h2 class="requests-title">
                  Requests Sent
                  (<%= @conversation.appointments.where(
                         "buyer_id = ? AND date >= ?",
                         current_user.id,
                         Time.now
                       ).count %>)
                </h2>
                
                <ol class="requests-list">
                  <% @conversation.appointments.where(
                       "buyer_id = ? AND date >= ?",
                       current_user.id,
                       Time.now
                     ).each do |appointment| %>
                     
                    <li id="request-item-<%= appointment.id %>" 
                        class="request-item">
                      <table class="request-item-content">
                        <tr>
                          
                          <td class="request-item-detail">
                            
                            <%= link_to appointment.vehicle.listing_name,
                                        appointment.vehicle, 
                                        class: "request-item-vehicle" %>
                            
                            <span class="request-item-date">
                              <%= appointment.date.strftime(
                                    "%A, %d %b (%-l:%M%p)"
                                  ) %>
                            </span>
                          </td>
                          
                          <td class="request-item-status-container">
                            <span class="request-item-status
                                         <%= appointment.status %>">
                              <%= appointment.status.capitalize %>
                            </span>
                          </td>
                        </tr>
                      </table>  
                    </li>
                  <% end %>
                </ol>
              </div>
            <% end %>
          </div>
        <% end %>
      </div>
      
      <div class="col-md-8 col-md-offset-1">

        <% if @conversation.appointments.exists?(
                status: 'pending', seller_id: current_user.id
              ) %>
          <div class="test-drive-response">
            
            <h1 class="test-drive-response-title">
              Respond to <%= @other.first_name %>'s 
              <%= pluralize_without_count(
                    @conversation.appointments.where(
                      status: 'pending', seller_id: current_user.id
                    ).count, "request"
                  ) %>
            </h1>
            
            <span class="test-drive-response-info">
              <i class="fa fa-clock-o fa-lg" aria-hidden="true"></i>
              Respond within 24 hours to maintain your response rate
            </span>
            
            <ol class="test-drive-response-list">
              <% @conversation.appointments.where(
                    status: 'pending', seller_id: current_user.id
                 ).each do |appointment| %>
                  
                <li id="response-item-<%= appointment.id %>" 
                    class="response-item">
                  <div class="row response-item-content">
                    
                    <div class="col-md-6 response-detail">
                      
                      <%= link_to appointment.vehicle.listing_name,
                                  appointment.vehicle, 
                                  class: "response-vehicle" %>
                      
                      <span class="response-date">
                        <%= appointment.date.strftime(
                              "%A, %d %b (%-l:%M%p)"
                            ) %>
                      </span>
                    </div>
                    
                    <div class="col-md-6">
                      
                      <%= link_to "Accept",
                                  accept_vehicle_appointment_path(appointment.vehicle, appointment),
                                  method: :put,
                                  class: "btn btn-test-drive-accept" %>
        
                      <%= link_to "Decline",
                                  decline_vehicle_appointment_path(appointment.vehicle, appointment),
                                  method: :put,
                                  class: "btn btn-test-drive-decline" %>
                    </div>
                  </div>
                  
                  <!--<table class="response-item-content">-->
                  <!--  <tr>-->
                      
                  <!--    <td class="response-detail">-->
                        
                  <!--      <(perc)= link_to appointment.vehicle.listing_name,-->
                  <!--                  appointment.vehicle, -->
                  <!--                  class: "response-vehicle" %>-->
                        
                  <!--      <span class="response-date">-->
                  <!--        <(perc)= appointment.date.strftime(-->
                  <!--              "%A, %d %b (%-l:%M%p)"-->
                  <!--            ) %>-->
                  <!--      </span>-->
                  <!--    </td>-->
                      
                  <!--    <td class="response-buttons">-->
                        
                  <!--      <(perc)= link_to "Accept",-->
                  <!--                  accept_vehicle_appointment_path(appointment.vehicle, appointment),-->
                  <!--                  method: :put,-->
                  <!--                  class: "btn btn-test-drive-accept" %>-->
          
                  <!--      <(perc)= link_to "Decline",-->
                  <!--                  decline_vehicle_appointment_path(appointment.vehicle, appointment),-->
                  <!--                  method: :put,-->
                  <!--                  class: "btn btn-test-drive-decline" %>-->
                  <!--    </td>-->
                  <!--  </tr>-->
                  <!--</table>-->
                </li>
              <% end %>
            </ol>
          </div>
        <% end %>
        
        <span class="response-stats">
          <% if (current_user.id == @conversation.sender_id  && @conversation.recipient_last_viewed_at.present?) %>
            <% if @conversation.recipient_last_viewed_at.today? %>
              Last viewed by <%= @other.first_name %>: <strong>Today</strong> at <strong><%= @conversation.recipient_last_viewed_at.strftime("%-l:%M%p") %></strong>
            <% else %>
              Last viewed by <%= @other.first_name %> on: <strong><%= @conversation.recipient_last_viewed_at.strftime("%d %B %Y") %></strong>
            <% end %>
          <% elsif (current_user.id == @conversation.recipient_id)  %>
            <% if @conversation.sender_last_viewed_at.today? %>
              Last viewed by <%= @other.first_name %>: <strong>Today</strong> at <strong><%= @conversation.sender_last_viewed_at.strftime("%-l:%M%p") %></strong>
            <% else %>
              Last viewed by <%= @other.first_name %> on: <strong><%= @conversation.sender_last_viewed_at.strftime("%d %B %Y") %></strong>
            <% end %>
          <% end %>
        </span>
        
        <%= render 'form' %>

        <div id="chat">
          
          <% @messages_by_day.sort.reverse_each do |day, messages| %>
          
            <% unless day.today? %>
              <span class="response-stats">
                <strong><%= day.strftime("%d %B %Y") %></strong>
              </span>
            <% end %>
            
            <% for message in messages %>
              <%= render partial: 'message', object: message %>
            <% end %>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>

<%= subscribe_to conversation_messages_path(@conversation) %>

<!--must login iot access-->
<!--change title-->
<!--add average rating-->
<!--switch var in javascript to new formatting-->
<!--report user/message-->
<!--link-to alignment/formatting-->
<!--why 3.5em for top and bottom padding-->